@inject IJSRuntime JsRuntime

@using System.Globalization
@implements IDisposable

<CascadingValue Value="this">
    @ChildContent
</CascadingValue>

@code {

    [Parameter]
    public RenderFragment ChildContent { get; set; }

    private bool _isOpen;

    private DotNetObjectReference<DropdownContainer> _objRef;

    public string DropdownOpenClass => _isOpen ? "open" : "";

    public readonly string Id = Guid.NewGuid().ToString("D", CultureInfo.InvariantCulture);

    private string Selector => $"#{Id}";

    protected override void OnInitialized()
    {
        _objRef = DotNetObjectReference.Create(this);
    }

    public Task DropdownToggle() => _isOpen ? DropdownClose() : DropdownOpen();

    public async Task DropdownOpen()
    {
        if (!_isOpen)
        {
            await JsRuntime.InvokeVoidAsync("helpers.clickedOutsideAddListener",
                _objRef,
                nameof(DropdownClickedOff),
                Selector);
            _isOpen = true;
        }
    }

    public async Task DropdownClose()
    {
        if (_isOpen)
        {
            await JsRuntime.InvokeVoidAsync(
                "helpers.clickedOutsideRemoveListener",
                Selector);
            _isOpen = false;
        }
    }

    [JSInvokable]
    public async Task DropdownClickedOff()
    {
        await DropdownClose();
        StateHasChanged();
    }

    public void Dispose()
    {
        if (_objRef != null)
        {
#pragma warning disable 4014
            DropdownClose();
#pragma warning restore 4014
            _objRef.Dispose();
        }
    }

}
